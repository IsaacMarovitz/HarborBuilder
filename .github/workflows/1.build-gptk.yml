# Task to automatically build `apple/apple/game-porting-toolkit` 
# and put the resulting Cellar into a dmg

name: Build GPTK
on:
  - workflow_dispatch

jobs:
  build_gptk:
    name: Build GPTK
    strategy:
        matrix:
          flavour: [Vanilla, Vulkan]
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install compiler
        run: |
          brew install apple/apple/game-porting-toolkit-compiler
      - if: matrix.flavour == 'Vulkan'
        name: Patch the formula
        run: |
          patch `brew --repo apple/apple`/Formula/game-porting-toolkit.rb < patches/enable-vulkan-sdl.patch
      - name: Install GPTK
        run: |
          brew install --build-bottle apple/apple/game-porting-toolkit
          brew bottle apple/apple/game-porting-toolkit
          touch i_am_here_to_prevent_macOS_from_untarring_the_bottle
      - name: Upload bottle archive
        uses: actions/upload-artifact@v3
        with:
          name: GTPK ${{matrix.flavour}} brew bottle (Harbor)
          path: |
            *.bottle.tar.gz
            i_am_here_to_prevent_macOS_from_untarring_the_bottle
      - name: Capture the Cellar tree (for Whisky)
        run: |
          mkdir gptk-cellar-tree
          cp -r /usr/local/Cellar/game-porting-toolkit/$(ls /usr/local/Cellar/game-porting-toolkit/) gptk-cellar-tree/Wine
          rm -rvf gptk-cellar-tree/Wine/include
          rm -rvf gptk-cellar-tree/Wine/INSTALL_RECEIPT.json
          rm -rvf gptk-cellar-tree/Wine/share/man
          # Remove every bin that **isn't** wine64, wineserver or wine64-preloader
          find gptk-cellar-tree/Wine/bin -type f -not -name "wine64" -not -name "wineserver" -not -name "wine64-preloader" -delete
          touch gptk-cellar-tree/i_am_here_to_prevent_macOS_from_untarring_the_bottle
          tar -czvf gptk-cellar-tree.tar.gz gptk-cellar-tree
      - name: Upload Cellar tree
        uses: actions/upload-artifact@v3
        with:
          name: GTPK ${{matrix.flavour}} Cellar tree (Whisky)
          path: gptk-cellar-tree

    
